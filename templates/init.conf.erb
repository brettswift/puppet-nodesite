#!upstart
description "node.js server"
author      "Brett Swift"

start on startup
stop on shutdown
# PID_FILE=/var/run/<%=@project_name%>.pid
expect fork

respawn

script
    export HOME="/root"
    export NODE_EXEC="<%=@node_exec_dir%>/node"
    export NPM_EXEC="<%=@node_exec_dir%>/npm"
    export APP_DIR='<%=@repo_dir%>/<%=@project_name%>'
    export NODE_ENV=production #TODO: set node_env variable, and other node variables
    export NODE_CONFIG_DIR=$APP_DIR/config
    
    echo $$ > /var/run/<%=@project_name%>.pid
    exec 
    exec $NODE_EXEC $APP_DIR/<%=@file_to_run%> >> /var/log/<%=@project_name%>.sys.log 2>&1
end script

pre-start script
    # Date format same as (new Date()).toISOString() for consistency
    echo "[`date -u +%Y-%m-%dT%T.%3NZ`] (sys) Starting" >> /var/log/<%=@project_name%>.sys.log
end script

pre-stop script
    rm /var/run/<%=@project_name%>.pid
    echo "[`date -u +%Y-%m-%dT%T.%3NZ`] (sys) Stopping" >> /var/log/<%=@project_name%>.sys.log
end script